name: Code Coverage

on:
  pull_request:
    branches: [main, master, develop]
  push:
    branches: [main, master, develop, 'feat/**']

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  coverage:
    name: Coverage Check
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper diff coverage

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[test]
        pip install requests coverage-badge diff-cover

    - name: Run tests with coverage
      run: |
        pytest --cov=src --cov-report=xml --cov-report=term --cov-report=html --cov-report=json || true

    - name: Generate detailed coverage report
      id: detailed_coverage
      run: |
        # Generate detailed module coverage
        echo "COVERAGE_DETAILS<<EOF" >> $GITHUB_OUTPUT
        python -c "
        import json
        try:
            with open('coverage.json') as f:
                data = json.load(f)

            files = data['files']
            details = []

            for filepath, file_data in files.items():
                if filepath.startswith('src/paymcp/'):
                    module = filepath.replace('src/paymcp/', '').replace('/', '.').replace('.py', '')
                    coverage_pct = round(file_data['summary']['percent_covered'], 1)
                    details.append(f'- **{module}**: {coverage_pct}%')

            if details:
                print('\n'.join(details))
            else:
                print('- No detailed coverage data available')
        except Exception as e:
            print(f'- Error generating details: {str(e)}')
        " >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Generate coverage badge
      run: |
        coverage-badge -o coverage.svg -f

    - name: Check overall coverage
      id: coverage_check
      run: |
        # Extract overall coverage from XML report
        OVERALL_COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); root = tree.getroot(); print(int(float(root.get('line-rate', 0)) * 100))")

        echo "overall_coverage=$OVERALL_COVERAGE" >> $GITHUB_OUTPUT
        echo "Overall coverage: $OVERALL_COVERAGE%"

        # Check if overall coverage meets 90% threshold
        if [ "$OVERALL_COVERAGE" -lt "90" ]; then
          echo "❌ Overall coverage is below 90% threshold ($OVERALL_COVERAGE%)"
          echo "coverage_status=failed" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "✅ Overall coverage meets 90% threshold ($OVERALL_COVERAGE%)"
          echo "coverage_status=passed" >> $GITHUB_OUTPUT
        fi


    - name: Comment PR with coverage report
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const overallCoverage = '${{ steps.coverage_check.outputs.overall_coverage }}' || 'N/A';
          const coverageStatus = '${{ steps.coverage_check.outputs.coverage_status }}';

          const statusEmoji = coverageStatus === 'passed' ? '✅' : '❌';
          const statusText = coverageStatus === 'passed' ? 'PASSED' : 'FAILED';

          const coverageDetails = `${{ steps.detailed_coverage.outputs.COVERAGE_DETAILS }}`;

          const comment = `## ${statusEmoji} Coverage Report

          ### Summary
          - **Overall Coverage:** ${overallCoverage}% (Minimum required: 90%)
          - **Status:** ${statusText}

          ### Module Coverage
          ${coverageDetails}

          ${coverageStatus === 'failed' ? '### ⚠️ Action Required\nPlease add tests to ensure overall coverage is at least 90%.' : '### ✨ Great job!\nYour code meets the coverage requirements.'}

          ---
          *Coverage report generated for commit ${context.sha.substring(0, 7)} at ${new Date().toISOString()}*`;

          // Find and delete ALL existing coverage comments (not just bot comments)
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const coverageComments = comments.filter(comment =>
            comment.body.includes('Coverage Report') ||
            comment.body.includes('Overall Coverage') ||
            comment.body.includes('Module Coverage') ||
            comment.body.includes('%') && comment.body.includes('coverage')
          );

          // Delete all existing coverage comments
          for (const comment of coverageComments) {
            try {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id,
              });
            } catch (error) {
              console.log(`Could not delete coverage comment ${comment.id}: ${error.message}`);
            }
          }

          // Create new comment
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports-${{ github.sha }}
        path: |
          coverage.xml
          coverage.json
          htmlcov/
          coverage.svg
        retention-days: 30

    - name: Add coverage check status
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const overallCoverage = '${{ steps.coverage_check.outputs.overall_coverage }}' || '0';
          const status = '${{ steps.coverage_check.outputs.coverage_status }}' === 'passed' ? 'success' : 'failure';

          await github.rest.checks.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            name: 'Code Coverage Quality Gate',
            head_sha: context.sha,
            status: 'completed',
            conclusion: status,
            output: {
              title: `Overall Coverage: ${overallCoverage}%`,
              summary: status === 'success'
                ? `✅ Overall coverage (${overallCoverage}%) meets the 90% threshold`
                : `❌ Overall coverage (${overallCoverage}%) is below the 90% threshold`,
            }
          });